# フォルダ構成

## プロジェクト全体構成

```plaintext
studio-view/
├── .github/                          # GitHub設定
├── docs/                             # ドキュメント
├── frontend/                         # Next.jsフロントエンド
├── server/                           # Express + Prismaバックエンド
├── pipeline/                         # FastAPI変換パイプライン
├── compose.yaml                      # Docker Compose設定
├── CLAUDE.md                         # プロジェクト開発ルール
└── README.md                         # プロジェクト概要
```

---

## Frontend (Next.js)

```plaintext
frontend/
├── public/                           # 静的ファイル
│   ├── glb/                          # GLBファイル
│   │   ├── FlexiSpot_cherryblossom
│   │   |   ├── FlexiSpot_cherryblossom.glb # 3Dモデル
│   │   |   └── FlexiSpot_cherryblossom.png # サムネイル画像
│   └── obj/
├── src/
│   ├── app/                          # App Router
│   │   ├── layout.tsx                # ルートレイアウト
│   │   ├── page.tsx                  # トップ画面 (/)
│   │   ├── globals.css               # グローバルスタイル
│   │   ├── api/                      # API Routes
│   │   │   ├── models/
│   │   │   │   └── route.ts          # パブリックモデルAPI
│   │   │   ├── assets/
│   │   │   │   ├── route.ts          # アセット一覧・作成API
│   │   │   │   └── [id]/
│   │   │   │       └── route.ts      # アセット詳細・削除API
│   │   │   ├── conversion/
│   │   │   │   ├── obj2glb/
│   │   │   │   │   └── route.ts      # OBJ→GLB変換API
│   │   │   │   └── obj2gltf/
│   │   │   │       └── route.ts      # OBJ→GLTF変換API
│   │   │   ├── settings/
│   │   │   │   └── route.ts          # ユーザー設定API
│   │   │   └── history/
│   │   │       └── recent/
│   │   │           └── route.ts      # 閲覧履歴API
│   │   ├── collection/
│   │   │   └── page.tsx              # コレクション画面 (/collection)
│   │   ├── viewer/
│   │   │   └── page.tsx              # 3Dビューワー画面 (/viewer)
│   │   ├── conversion/
│   │   │   └── page.tsx              # 変換画面 (/conversion)
│   │   ├── login/
│   │   │   └── page.tsx              # ログイン画面 (/login)
│   │   └── settings/
│   │       └── page.tsx              # 設定画面 (/settings)
│   ├── components/                   # Reactコンポーネント
│   │   ├── ui/                       # 汎用UIコンポーネント
│   │   │   ├── Button/
│   │   │   │   ├── Button.tsx
│   │   │   │   └── Button.test.tsx
│   │   │   ├── Card/
│   │   │   │   └── Card.tsx
│   │   │   ├── Input/
│   │   │   │   └── Input.tsx
│   │   │   ├── Select/
│   │   │   │   └── Select.tsx
│   │   │   └── Badge/
│   │   │       └── Badge.tsx
│   │   ├── layout/                   # レイアウトコンポーネント
│   │   │   ├── MainHeader.tsx        # メインヘッダー
│   │   │   ├── AccountButton.tsx     # アカウントメニュー
│   │   │   └── Footer.tsx            # フッター
│   │   ├── three/                    # Three.js関連コンポーネント
│   │   │   ├── ViewerCanvas.tsx      # 3Dビューワーキャンバス
│   │   │   └── ControlPanel.tsx      # ビューワーコントロール
│   │   ├── features/                 # 機能別コンポーネント
│   │   │   ├── collection/
│   │   │   │   ├── AssetCard.tsx     # アセットカード
│   │   │   │   ├── FileUpload.tsx    # ファイルアップロード
│   │   │   │   └── LibraryGrid.tsx   # ライブラリグリッド
│   │   │   ├── conversion/
│   │   │   │   ├── ConversionForm.tsx# 変換フォーム
│   │   │   │   └── ConversionResult.tsx# 変換結果表示
│   │   │   └── settings/
│   │   │       ├── AccountInfo.tsx   # アカウント情報
│   │   │       ├── LanguageSelector.tsx# 言語選択
│   │   │       └── StorageUsage.tsx  # ストレージ使用状況
│   │   └── providers/                # Context Providers
│   │       ├── LanguageProvider.tsx  # 言語プロバイダー
│   │       └── AuthProvider.tsx      # 認証プロバイダー
│   ├── lib/                          # ユーティリティとロジック
│   │   ├── utils.ts                  # ヘルパー関数 (cn等)
│   │   ├── store.ts                  # Zustand状態管理
│   │   ├── i18n.ts                   # 国際化設定
│   │   ├── api-client.ts             # APIクライアント
│   │   └── validators.ts             # バリデーション関数
│   ├── locales/                      # 多言語対応
│   │   ├── en.json                   # 英語翻訳
│   │   └── ja.json                   # 日本語翻訳
│   ├── types/                        # TypeScript型定義
│   │   ├── asset.ts                  # アセット型
│   │   ├── user.ts                   # ユーザー型
│   │   ├── api.ts                    # APIレスポンス型
│   │   └── index.ts                  # 型エクスポート
│   └── hooks/                        # カスタムReact Hooks
│       ├── useAssets.ts              # アセット管理フック
│       ├── useAuth.ts                # 認証フック
│       └── useLanguage.ts            # 言語フック
├── test/                             # テスト
│   ├── e2e/                          # E2Eテスト
│   │   ├── home.spec.ts
│   │   ├── collection.spec.ts
│   │   ├── viewer.spec.ts
│   │   ├── results/                  # テスト結果
│   │   └── report/                   # レポート
│   └── setup.ts                      # テストセットアップ
├── .env.local                        # ローカル環境変数
├── .env.example                      # 環境変数サンプル
├── package.json                      # 依存関係
├── pnpm-lock.yaml                    # パッケージロック
├── tsconfig.json                     # TypeScript設定
├── next.config.ts                    # Next.js設定
├── vitest.config.ts                  # Vitest設定
├── playwright.config.ts              # Playwright設定
├── tailwind.config.ts                # Tailwind CSS設定
├── eslint.config.mjs                 # ESLint設定
└── Dockerfile                        # Docker設定
```

---

## Server (Express + Prisma)

```plaintext
server/
├── prisma/                           # Prismaスキーマ
│   ├── schema.prisma                 # DBスキーマ定義
│   ├── migrations/                   # マイグレーションファイル
│   │   └── 20260101000000_init/
│   │       └── migration.sql
│   └── seed.ts                       # シーディングスクリプト
├── src/
│   ├── domain/                       # ドメイン層
│   │   ├── entities/                 # エンティティ
│   │   │   ├── User.ts
│   │   │   ├── Asset.ts
│   │   │   ├── RecentHistory.ts
│   │   │   └── ConversionJob.ts
│   │   ├── repositories/             # リポジトリインターフェース
│   │   │   ├── IUserRepository.ts
│   │   │   ├── IAssetRepository.ts
│   │   │   └── IConversionJobRepository.ts
│   │   └── services/                 # ドメインサービス
│   │       ├── StorageService.ts     # ストレージ容量管理
│   │       └── AuthService.ts        # 認証ロジック
│   ├── application/                  # アプリケーション層
│   │   ├── usecases/                 # ユースケース
│   │   │   ├── auth/
│   │   │   │   ├── LoginUseCase.ts
│   │   │   │   ├── LogoutUseCase.ts
│   │   │   │   └── RefreshTokenUseCase.ts
│   │   │   ├── assets/
│   │   │   │   ├── GetAssetsUseCase.ts
│   │   │   │   ├── CreateAssetUseCase.ts
│   │   │   │   ├── GetAssetByIdUseCase.ts
│   │   │   │   └── DeleteAssetUseCase.ts
│   │   │   ├── conversion/
│   │   │   │   ├── ConvertObj2GlbUseCase.ts
│   │   │   │   └── ConvertObj2GltfUseCase.ts
│   │   │   └── settings/
│   │   │       ├── GetSettingsUseCase.ts
│   │   │       └── UpdateSettingsUseCase.ts
│   │   └── dto/                      # データ転送オブジェクト
│   │       ├── AuthDTO.ts
│   │       ├── AssetDTO.ts
│   │       └── SettingsDTO.ts
│   ├── infrastructure/               # インフラ層
│   │   ├── database/                 # データベース
│   │   │   ├── prisma.ts             # Prismaクライアント
│   │   │   └── repositories/         # リポジトリ実装
│   │   │       ├── UserRepository.ts
│   │   │       ├── AssetRepository.ts
│   │   │       └── ConversionJobRepository.ts
│   │   ├── storage/                  # ストレージ
│   │   │   ├── S3Client.ts           # S3クライアント
│   │   │   └── FileUploadService.ts  # ファイルアップロード
│   │   ├── external/                 # 外部サービス
│   │   │   └── ConversionClient.ts   # 変換パイプラインクライアント
│   │   └── auth/                     # 認証
│   │       ├── JWTService.ts         # JWT生成・検証
│   │       └── PasswordService.ts    # パスワードハッシュ化
│   ├── presentation/                 # プレゼンテーション層
│   │   ├── controllers/              # コントローラー
│   │   │   ├── AuthController.ts
│   │   │   ├── AssetController.ts
│   │   │   ├── ConversionController.ts
│   │   │   ├── SettingsController.ts
│   │   │   └── HistoryController.ts
│   │   ├── middlewares/              # ミドルウェア
│   │   │   ├── authMiddleware.ts     # 認証ミドルウェア
│   │   │   ├── errorHandler.ts       # エラーハンドリング
│   │   │   ├── rateLimiter.ts        # レート制限
│   │   │   └── validator.ts          # バリデーション
│   │   └── routes/                   # ルート定義
│   │       ├── authRoutes.ts
│   │       ├── assetRoutes.ts
│   │       ├── conversionRoutes.ts
│   │       ├── settingsRoutes.ts
│   │       └── historyRoutes.ts
│   ├── config/                       # 設定
│   │   ├── env.ts                    # 環境変数管理
│   │   ├── database.ts               # DB設定
│   │   └── storage.ts                # ストレージ設定
│   ├── utils/                        # ユーティリティ
│   │   ├── logger.ts                 # ロガー
│   │   ├── errors.ts                 # カスタムエラー
│   │   └── validators.ts             # バリデーター
│   └── index.ts                      # エントリーポイント
├── tests/                            # テスト
│   ├── unit/                         # ユニットテスト
│   │   ├── domain/
│   │   ├── application/
│   │   └── infrastructure/
│   ├── integration/                  # 統合テスト
│   │   └── api/
│   └── setup.ts                      # テストセットアップ
├── .env                              # 環境変数
├── .env.example                      # 環境変数サンプル
├── package.json                      # 依存関係
├── tsconfig.json                     # TypeScript設定
├── jest.config.js                    # Jestテスト設定
├── Dockerfile                        # Docker設定
└── README.md                         # サーバードキュメント
```

---

## Pipeline (FastAPI)

```plaintext
pipeline/
├── src/
│   ├── domain/                       # ドメイン層
│   │   ├── models/                   # ドメインモデル
│   │   │   ├── conversion_request.py
│   │   │   └── conversion_result.py
│   │   └── services/                 # ドメインサービス
│   │       └── conversion_service.py # 変換ロジック
│   ├── application/                  # アプリケーション層
│   │   ├── usecases/                 # ユースケース
│   │   │   ├── obj_to_glb_usecase.py
│   │   │   └── obj_to_gltf_usecase.py
│   │   └── dto/                      # DTO
│   │       └── conversion_dto.py
│   ├── infrastructure/               # インフラ層
│   │   ├── converters/               # 変換ツール
│   │   │   ├── obj2gltf_converter.py # obj2gltfラッパー
│   │   │   └── gltf2glb_converter.py # GLTF→GLB変換
│   │   ├── storage/                  # ストレージ
│   │   │   └── s3_client.py          # S3クライアント
│   │   └── validators/               # ファイル検証
│   │       └── model_validator.py    # 3Dモデル検証
│   ├── presentation/                 # プレゼンテーション層
│   │   ├── routers/                  # ルーター
│   │   │   ├── conversion.py         # 変換エンドポイント
│   │   │   └── health.py             # ヘルスチェック
│   │   ├── schemas/                  # Pydanticスキーマ
│   │   │   ├── request.py            # リクエストスキーマ
│   │   │   └── response.py           # レスポンススキーマ
│   │   └── dependencies/             # 依存性注入
│   │       └── auth.py               # 認証依存性
│   ├── config/                       # 設定
│   │   ├── settings.py               # 環境変数設定
│   │   └── logging.py                # ロギング設定
│   ├── utils/                        # ユーティリティ
│   │   ├── file_utils.py             # ファイル操作
│   │   └── errors.py                 # カスタムエラー
│   └── main.py                       # FastAPIアプリケーション
├── tests/                            # テスト
│   ├── unit/                         # ユニットテスト
│   │   └── test_converters.py
│   ├── integration/                  # 統合テスト
│   │   └── test_api.py
│   └── fixtures/                     # テストデータ
│       ├── sample.obj
│       └── sample.glb
├── .env                              # 環境変数
├── .env.example                      # 環境変数サンプル
├── requirements.txt                  # Python依存関係
├── Dockerfile                        # Docker設定
├── pytest.ini                        # Pytestテスト設定
└── README.md                         # パイプラインドキュメント
```

---

## 環境変数設定

### Frontend (.env)

```bash
# Next.js
NEXT_PUBLIC_API_URL=http://localhost:4000/api
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### Server (.env)

```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/studio_view

# JWT
JWT_SECRET=your-secret-key-here
JWT_EXPIRES_IN=3600

# Pipeline
PIPELINE_API_URL=http://localhost:8000

# Server
PORT=4000
NODE_ENV=development
```

### Pipeline (.env)

```bash
# FastAPI
API_HOST=0.0.0.0
API_PORT=8000
DEBUG=True


# Conversion
MAX_FILE_SIZE=104857600  # 100MB
TEMP_DIR=/tmp/conversions
```

---

## Docker 設定

### compose.yaml

```yaml
version: "3.9"

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:4000/api
    depends_on:
      - server

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/studio_view
      - PIPELINE_API_URL=http://pipeline:8000
    depends_on:
      - db
      - pipeline

  pipeline:
    build:
      context: ./pipeline
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - API_PORT=8000

  db:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=studio_view
    volumes:
      - db_data:/var/lib/postgresql/data

volumes:
  db_data:
```

---

## 開発フロー

### ローカル開発

```bash
# フロントエンド
cd frontend
pnpm install
pnpm dev

# サーバー
cd server
npm install
npx prisma generate
npx prisma migrate dev
npm run dev

# パイプライン
cd pipeline
pip install -r requirements.txt
uvicorn src.main:app --reload
```

### Docker 開発

```bash
# すべてのサービス起動
docker compose up --build

# 個別サービス起動
docker compose up frontend
docker compose up server
docker compose up pipeline
```

### テスト実行

```bash
# フロントエンド
cd frontend
pnpm test              # ユニットテスト
pnpm test:e2e          # E2Eテスト

# サーバー
cd server
npm test               # すべてのテスト
npm run test:unit      # ユニットテスト
npm run test:integration # 統合テスト

# パイプライン
cd pipeline
pytest                 # すべてのテスト
pytest tests/unit      # ユニットテスト
```

---

## セキュリティ考慮事項

### API 認証

- JWT トークンによる認証
- リフレッシュトークン実装
- レート制限による攻撃対策

### データ保護

- 環境変数での機密情報管理
- SSL/TLS 通信の強制
- パスワードのハッシュ化（bcrypt）
