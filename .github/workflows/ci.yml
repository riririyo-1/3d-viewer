name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # changes:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     frontend: ${{ steps.filter.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch' }}
  #     server: ${{ steps.filter.outputs.server == 'true' || github.event_name == 'workflow_dispatch' }}
  #     pipeline: ${{ steps.filter.outputs.pipeline == 'true' || github.event_name == 'workflow_dispatch' }}
  #     docker: ${{ steps.filter.outputs.docker == 'true' || github.event_name == 'workflow_dispatch' }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: dorny/paths-filter@v3
  #       id: filter
  #       with:
  #         filters: |
  #           frontend:
  #             - 'frontend/**'
  #           server:
  #             - 'server/**'
  #           pipeline:
  #             - 'pipeline/**'
  #           docker:
  #             - 'frontend/Dockerfile'
  #             - 'server/Dockerfile'
  #             - 'pipeline/Dockerfile'
  #             - 'compose.yaml'

  frontend-lint:
    # needs: changes
    # if: ${{ needs.changes.outputs.frontend == 'true' }}

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-frontend-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-frontend-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Lint
        run: pnpm lint
      - name: Type Check
        run: pnpm tsc --noEmit

  frontend-unit-test:
    # needs: changes
    # if: ${{ needs.changes.outputs.frontend == 'true' }}

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-frontend-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-frontend-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run Unit Tests
        run: pnpm test run

  frontend-e2e-test:
    # needs: changes
    # if: ${{ needs.changes.outputs.frontend == 'true' }}

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: studio_view
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-frontend-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-frontend-
      - name: Install Frontend Dependencies
        run: pnpm install --frozen-lockfile
      - name: Install Backend Dependencies
        run: |
          cd ${{ github.workspace }}/server
          pnpm install --frozen-lockfile
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps
      - name: Start MinIO
        run: |
          docker run -d -p 9000:9000 -p 9001:9001 --name minio \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio server /data --console-address ":9001"
          timeout 30s bash -c 'until curl -s http://localhost:9000/minio/health/live; do sleep 1; done'
      - name: Setup Backend Database
        run: |
          cd ${{ github.workspace }}/server
          pnpm exec prisma generate
          pnpm exec prisma migrate deploy
          pnpm exec prisma db seed
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/studio_view
      - name: Start Backend Server
        run: |
          cd ${{ github.workspace }}/server
          pnpm start:dev > /tmp/backend.log 2>&1 &
          echo $! > /tmp/backend.pid
          timeout 30s bash -c 'until curl -s http://localhost:4000; do sleep 1; done' || (cat /tmp/backend.log && exit 1)
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/studio_view
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          MINIO_ENDPOINT: localhost
          MINIO_PORT: 9000
          MINIO_ACCESS_KEY: minioadmin
          MINIO_SECRET_KEY: minioadmin
          MINIO_BUCKET_NAME: studio-view-assets
          JWT_SECRET: test-secret
          PORT: 4000
          CORS_ORIGINS: http://localhost:3000
          GOOGLE_CLIENT_ID: "test-client-id"
          GOOGLE_CLIENT_SECRET: "test-client-secret"
          GOOGLE_CALLBACK_URL: "http://localhost:3000/auth/google/callback"
      - name: Build Frontend
        run: pnpm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:4000
      - name: Start Frontend Server
        run: |
          pnpm start > /tmp/frontend.log 2>&1 &
          echo $! > /tmp/frontend.pid
          timeout 30s bash -c 'until curl -s http://localhost:3000; do sleep 1; done' || (cat /tmp/frontend.log && exit 1)
        env:
          NEXT_PUBLIC_API_URL: http://localhost:4000
      - name: Run E2E Tests
        run: pnpm exec playwright test --config=playwright.config.ci.ts
        env:
          CI: true
          NEXT_PUBLIC_API_URL: http://localhost:4000
      - name: Upload Playwright Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-playwright-report
          path: frontend/test/e2e/report/
          retention-days: 30

  backend-lint:
    # needs: changes
    # if: ${{ needs.changes.outputs.server == 'true' }}

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-server-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-server-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Security Scan (Audit)
        run: pnpm audit --audit-level=high || true
      - name: Lint
        run: pnpm lint
      - name: Prisma Generate
        run: pnpm exec prisma generate
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/studio_view
      - name: Prisma Validate
        run: pnpm exec prisma validate
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/studio_view

  backend-unit-test:
    # needs: changes
    # if: ${{ needs.changes.outputs.server == 'true' }}

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-server-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-server-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Prisma Generate
        run: pnpm exec prisma generate
      - name: Unit Tests
        run: pnpm test
      - name: Test Coverage
        run: pnpm test:cov

  backend-e2e-test:
    # needs: changes
    # if: ${{ needs.changes.outputs.server == 'true' }}

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    services:
      db:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: studio_view
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-server-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-server-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Start Minio
        run: |
          docker run -d -p 9000:9000 -p 9001:9001 --name minio \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio server /data --console-address ":9001"
          timeout 30s bash -c 'until curl -s http://localhost:9000/minio/health/live; do sleep 1; done'
      - name: Prisma Generate
        run: pnpm exec prisma generate
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/studio_view
      - name: Prisma Migrate
        run: pnpm exec prisma migrate deploy
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/studio_view
      - name: Prisma Seed
        run: pnpm exec prisma db seed
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/studio_view
      - name: E2E Tests
        run: pnpm test:e2e
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/studio_view
          GOOGLE_CLIENT_ID: "test-client-id"
          GOOGLE_CLIENT_SECRET: "test-client-secret"
          GOOGLE_CALLBACK_URL: "http://localhost:3000/auth/google/callback"
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          MINIO_ENDPOINT: localhost
          MINIO_PORT: 9000
          MINIO_ACCESS_KEY: minioadmin
          MINIO_SECRET_KEY: minioadmin
          MINIO_BUCKET_NAME: studio-view-assets
          JWT_SECRET: test-secret

  pipeline-lint:
    # needs: changes
    # if: ${{ needs.changes.outputs.pipeline == 'true' }}

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./pipeline
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black mypy types-requests types-redis types-ujson
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      - name: Check formatting with Black
        run: black --check .
      - name: Type checking with mypy
        run: mypy . --ignore-missing-imports

  pipeline-test:
    # needs: changes
    # if: ${{ needs.changes.outputs.pipeline == 'true' }}

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./pipeline
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black mypy types-requests types-redis types-ujson
      - name: Run tests
        run: PYTHONPATH=. pytest

  integration-test:
    # needs: [changes, frontend-lint, backend-lint, pipeline-lint]
    # if: ${{ always() && (needs.changes.outputs.docker == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.server == 'true' || needs.changes.outputs.pipeline == 'true') }}
    needs: [frontend-lint, backend-lint, pipeline-lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Create .env file for CI
        run: |
          cat > server/.env << EOF
          DATABASE_URL=postgresql://user:password@db:5432/studio_view
          REDIS_HOST=redis
          REDIS_PORT=6379
          MINIO_ENDPOINT=minio
          MINIO_PORT=9000
          MINIO_USE_SSL=false
          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=minioadmin
          MINIO_BUCKET_NAME=studio-view-assets
          PIPELINE_API_URL=http://pipeline:8000
          PORT=4000
          JWT_SECRET=test-secret-key-for-ci-environment
          CORS_ORIGINS=http://localhost:3000
          GOOGLE_CLIENT_ID=test-client-id
          GOOGLE_CLIENT_SECRET=test-client-secret
          GOOGLE_CALLBACK_URL=http://localhost:3000/auth/google/callback
          EOF
      - name: Build and Start Services
        run: docker compose up -d --build
      - name: Check Services Health/Status
        run: |
          echo "Waiting for services to be ready..."
          sleep 60
          docker compose ps
          SERVICES=$(docker compose ps --services)
          for SERVICE in $SERVICES; do
            if [ -z "$(docker compose ps -q $SERVICE)" ]; then
              echo "Service $SERVICE is not running"
              exit 1
            fi
          done
          echo "Checking health status..."
          if [ -n "$(docker ps --format '{{.Names}} {{.State.Health.Status}}' | grep 'unhealthy')" ]; then
             echo "Some containers are unhealthy:"
             docker ps --format '{{.Names}} {{.State.Health.Status}}' | grep 'unhealthy'
             docker compose logs
             exit 1
          fi
          echo "All services up and running!"

  build-docker:
    # needs: [changes, frontend-lint, backend-lint, pipeline-lint]
    # if: ${{ always() && (needs.backend-lint.result == 'success' || needs.backend-lint.result == 'skipped') && (needs.pipeline-lint.result == 'success' || needs.pipeline-lint.result == 'skipped') && (needs.frontend-lint.result == 'success' || needs.frontend-lint.result == 'skipped') }}
    needs: [frontend-lint, backend-lint, pipeline-lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Image
        # if: ${{ needs.changes.outputs.frontend == 'true' || needs.changes.outputs.docker == 'true' }}

        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: studio-view-frontend:latest

      - name: Build Server Image
        # if: ${{ needs.changes.outputs.server == 'true' || needs.changes.outputs.docker == 'true' }}

        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: false
          tags: studio-view-server:latest

      - name: Build Pipeline Image
        # if: ${{ needs.changes.outputs.pipeline == 'true' || needs.changes.outputs.docker == 'true' }}

        uses: docker/build-push-action@v5
        with:
          context: ./pipeline
          file: ./pipeline/Dockerfile
          push: false
          tags: studio-view-pipeline:latest
